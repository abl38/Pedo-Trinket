clear all
close all
clc
%Reading in CSV data
data = csvread('Walking 36 Steps.txt');
% Data is in format [time, xData, yData, zData] 
% Time is in microseconds
time = data(:,1)/1000000;
xData = data(:,2);
yData = data(:,3);
zData = data(:,4);

%Find the average time in between ticks
avgDT = (time(end) - time(1)) / length(time)
Freq = 1/avgDT

%Center RAW x,y,z ACCELERATION data at 0
xData = xData - mean(xData);
yData = yData - mean(yData);
zData = zData - mean(zData);

% Find sum of RAW x,y,z ACEELERATION data
sumData = xData + yData + zData;

% Preliminary orientation of x,y,z data (not necessary right now)
xyData = xData + yData;
xzData = xData + zData;
yzData = yData + zData;


% Window for moving average filter (Higher value = More Smoothing, More Delay)
avgWindow = 12;

% Plot RAW Acceleration Data
figure
plot([xData yData zData])

%Plot FILTERED Acceleration Data
figure 
xAcc = mAvgFilter2(xData,avgWindow);
yAcc = mAvgFilter2(yData,avgWindow);
zAcc = mAvgFilter2(zData,avgWindow);

% Sum of Filtered x,y,z Acceleration Data
sumAcc = xAcc + yAcc + zAcc;

% Preliminary Filtered orientation x,y,z data (not necessary right now)
xyAcc = mAvgFilter2(xyData,avgWindow);
xzAcc = mAvgFilter2(xzData,avgWindow);
yzAcc = mAvgFilter2(yzData,avgWindow);

% Plot Filtered Sum, x,y,z Acceleration Data
plot([sumAcc xAcc yAcc zAcc])
legend('sumAcc','xAcc','yAcc','zAcc')

% Take discrete derivative of Acceleration
% Derivative = backDiff(Data, filterWindow)
xJerk = backDiff(xAcc,8);
yJerk = backDiff(yAcc,8);
zJerk = backDiff(zAcc,8);
sumJerk = xJerk + yJerk + zJerk;

xyJerk = xJerk + yJerk;
xzJerk = xJerk + zJerk;
yzJerk = yJerk + zJerk;

xJounce = backDiff(xJerk,5);
yJounce = backDiff(yJerk,5);
zJounce = backDiff(zJerk,5);

figure 
plot([sumJerk xJerk yJerk zJerk])
title('xJerk & yJerk; zJerk')
legend('sum','x','y','z')
figure
plot(xyJerk)

figure
plot([xyJerk xzJerk yzJerk])
legend( 'xyJerk', 'xzJerk', 'yzJerk')


%% Peak Detection using sumJerk

%EMA
Thresh6 = stdDev(sumJerk, avgWindow*6);
Thresh4 = stdDev(sumJerk, avgWindow*4);
Thresh2 = stdDev(sumJerk, avgWindow*2);

figure
plot([sumJerk Thresh6 Thresh4 Thresh2])
legend('sum','6x', '4x','2x')

%%
figure
threshJerk = 100;
jerkAboveT = (sumJerk > threshJerk)*threshJerk;
jerkBelowT = (sumJerk < -threshJerk)*-threshJerk;
plot([sumJerk jerkAboveT jerkBelowT])
title('sumJerk')

figure
threshAcc = 75;
accAboveT = (sumAcc > threshAcc)*threshAcc;
accBelowT = (sumAcc < -threshAcc)*-threshAcc;
plot([sumAcc accAboveT accBelowT])
title('sumAcc')